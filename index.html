<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>GST Sentinel – Professional GST Verification Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- SheetJS -->
  <script src="https://cdn.sheetjs.com/xlsx-0.20.2/package/dist/xlsx.full.min.js"></script>
  <!-- Lucide Icons -->
  <script src="https://unpkg.com/lucide@latest"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
    * { font-family: 'Inter', sans-serif; }

    body {
      background: radial-gradient(circle at top, #1e293b 0, #020617 45%);
    }

    .glass {
      background: rgba(15, 23, 42, 0.85);
      backdrop-filter: blur(18px);
      border: 1px solid rgba(148, 163, 184, 0.35);
    }

    .gradient-main {
      background: linear-gradient(135deg, #10b981, #22c55e);
    }

    .status-active     { background: linear-gradient(135deg, #10b981, #16a34a); color:#fff; box-shadow:0 0 16px rgba(16,185,129,.45); }
    .status-cancelled  { background: linear-gradient(135deg, #ef4444, #b91c1c); color:#fff; box-shadow:0 0 16px rgba(239,68,68,.45); }
    .status-suspended  { background: linear-gradient(135deg, #f59e0b, #d97706); color:#fff; box-shadow:0 0 16px rgba(245,158,11,.45); }
    .status-unknown    { background: linear-gradient(135deg, #6b7280, #4b5563); color:#fff; box-shadow:0 0 16px rgba(107,114,128,.45); }

    .drag-over {
      border-color:#10b981 !important;
      background:rgba(16,185,129,0.12) !important;
      transform:scale(1.01);
    }

    .slide-over { transform:translateX(100%); transition:transform .35s cubic-bezier(.4,0,.2,1); }
    .slide-over.open { transform:translateX(0); }

    .fade-in { animation:fadeIn .35s ease-out; }
    @keyframes fadeIn { from{opacity:0;transform:translateY(10px);} to{opacity:1;transform:translateY(0);} }

    .shimmer {
      background:linear-gradient(90deg,transparent,rgba(255,255,255,.18),transparent);
      animation:shimmer 2s infinite;
    }
    @keyframes shimmer { 0%{transform:translateX(-100%);} 100%{transform:translateX(100%);} }

    .scrollbar::-webkit-scrollbar { width:8px;height:8px; }
    .scrollbar::-webkit-scrollbar-track { background:#020617; }
    .scrollbar::-webkit-scrollbar-thumb { background:#10b981;border-radius:4px; }
  </style>
</head>
<body class="min-h-screen text-slate-100">

<!-- Password Gate (Frontend only, for UX; real security is GST data on server) -->
<div id="loginOverlay" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-950/95">
  <div class="glass rounded-3xl p-10 max-w-md w-full shadow-2xl fade-in">
    <div class="flex justify-center mb-7">
      <div class="gradient-main p-4 rounded-2xl shadow-xl">
        <i data-lucide="shield-check" class="w-10 h-10 text-white"></i>
      </div>
    </div>
    <h1 class="text-3xl font-extrabold text-center mb-1 bg-gradient-to-r from-emerald-400 to-emerald-500 bg-clip-text text-transparent">
      GST Sentinel
    </h1>
    <p class="text-center text-slate-400 mb-8 text-sm">Secure B2B GST Verification Suite for CAs and Enterprises</p>

    <form id="loginForm" class="space-y-5">
      <div>
        <label class="block text-sm font-semibold mb-2 text-slate-200">Access Password</label>
        <div class="relative">
          <input
            id="loginPassword"
            type="password"
            class="w-full px-4 py-3.5 bg-slate-900 border border-slate-700 rounded-xl focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 outline-none"
            placeholder="Enter dashboard password"
            autocomplete="off"
            required
          />
          <i data-lucide="lock" class="w-4 h-4 text-slate-500 absolute right-3 top-1/2 -translate-y-1/2"></i>
        </div>
      </div>
      <div id="loginError" class="hidden text-red-400 text-sm bg-red-500/10 border border-red-500/40 rounded-lg px-3 py-2"></div>
      <button
        type="submit"
        class="w-full gradient-main hover:brightness-110 text-white font-semibold py-3.5 rounded-xl flex items-center justify-center gap-2 transition"
      >
        <i data-lucide="log-in" class="w-4 h-4"></i>
        <span>Access Dashboard</span>
      </button>
    </form>

    <p class="mt-6 text-xs text-center text-slate-500 flex items-center justify-center gap-1">
      <i data-lucide="shield" class="w-3 h-3"></i> Designed for chartered accountants and B2B workflows
    </p>
  </div>
</div>

<!-- Header -->
<header class="sticky top-0 z-40 glass border-b border-slate-700/60">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex items-center justify-between">
    <div class="flex items-center gap-3">
      <div class="gradient-main p-2.5 rounded-xl shadow-lg">
        <i data-lucide="file-check" class="w-6 h-6 text-white"></i>
      </div>
      <div>
        <h1 class="text-xl font-bold">GST Sentinel</h1>
        <p class="text-xs text-slate-400">Real‑time GST profile verification dashboard</p>
      </div>
    </div>
    <div class="flex items-center gap-3">
      <button
        onclick="openHistory()"
        class="hidden sm:flex items-center gap-2 px-4 py-2 rounded-xl bg-slate-900/70 hover:bg-slate-800 border border-slate-700 text-sm transition"
      >
        <i data-lucide="clock" class="w-4 h-4 text-emerald-400"></i><span>History</span>
      </button>
    </div>
  </div>
</header>

<main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 space-y-8">

  <!-- Single GST Verification -->
  <section class="glass rounded-2xl p-7 shadow-xl fade-in">
    <div class="flex items-center gap-2 mb-4">
      <div class="bg-emerald-500/15 rounded-lg p-2">
        <i data-lucide="search" class="w-5 h-5 text-emerald-400"></i>
      </div>
      <h2 class="text-lg font-semibold">Single GST Verification</h2>
    </div>
    <div class="flex flex-col md:flex-row gap-3">
      <input
        id="singleGST"
        type="text"
        maxlength="15"
        class="flex-1 px-4 py-3.5 bg-slate-950/70 border border-slate-700 rounded-xl focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 outline-none uppercase font-mono text-base"
        placeholder="Enter 15‑digit GSTIN (e.g., 08ANHPR9127M1Z6)"
      />
      <button
        onclick="verifySingleGST()"
        class="gradient-main text-white px-6 py-3.5 rounded-xl font-semibold flex items-center justify-center gap-2 hover:brightness-110 transition"
      >
        <i data-lucide="shield-check" class="w-5 h-5"></i><span>Verify</span>
      </button>
    </div>
    <div id="singleResult" class="hidden mt-6"></div>
  </section>

  <!-- Bulk GST Verification -->
  <section class="glass rounded-2xl p-7 shadow-xl fade-in">
    <div class="flex items-center gap-2 mb-4">
      <div class="bg-emerald-500/15 rounded-lg p-2">
        <i data-lucide="upload-cloud" class="w-5 h-5 text-emerald-400"></i>
      </div>
      <h2 class="text-lg font-semibold">Bulk GST Verification</h2>
    </div>

    <div
      id="dropZone"
      class="border-2 border-dashed border-slate-600 rounded-2xl p-10 text-center cursor-pointer hover:border-emerald-500 transition"
    >
      <i data-lucide="file-spreadsheet" class="w-14 h-14 mx-auto mb-4 text-emerald-400"></i>
      <p class="text-base font-semibold mb-1">Drop Excel/CSV file here</p>
      <p class="text-xs text-slate-400 mb-2">or click to browse</p>
      <p class="text-[11px] text-slate-500">First column should contain GST numbers</p>
      <input id="fileInput" type="file" class="hidden" accept=".xlsx,.xls,.csv" />
    </div>

    <div id="progressContainer" class="hidden mt-6">
      <div class="flex items-center justify-between mb-2">
        <span id="progressText" class="text-sm text-slate-300">Processing...</span>
        <span id="progressCount" class="text-xs font-mono text-emerald-400">0/0</span>
      </div>
      <div class="w-full bg-slate-950 rounded-full h-3 overflow-hidden border border-slate-700">
        <div id="progressBar" class="gradient-main h-full relative transition-all duration-500" style="width:0%">
          <div class="absolute inset-0 shimmer"></div>
        </div>
      </div>
    </div>
  </section>

  <!-- Results Table -->
  <section id="resultsSection" class="hidden fade-in">
    <div class="glass rounded-2xl shadow-xl overflow-hidden">
      <div class="flex items-center justify-between px-6 py-4 border-b border-slate-700/70">
        <div class="flex items-center gap-2">
          <div class="bg-emerald-500/15 rounded-lg p-2">
            <i data-lucide="table" class="w-5 h-5 text-emerald-400"></i>
          </div>
          <h2 class="text-lg font-semibold">Verification Results</h2>
          <span id="resultCount" class="gradient-main text-xs font-semibold px-3 py-1 rounded-full ml-1">0</span>
        </div>
        <div class="flex items-center gap-2">
          <button
            onclick="clearResults()"
            class="px-3 py-2 rounded-xl bg-slate-900 hover:bg-slate-800 text-xs flex items-center gap-1 border border-slate-700"
          >
            <i data-lucide="trash-2" class="w-4 h-4 text-red-400"></i><span>Clear</span>
          </button>
          <button
            onclick="exportToExcel()"
            class="px-3 py-2 rounded-xl gradient-main text-xs flex items-center gap-1"
          >
            <i data-lucide="download" class="w-4 h-4"></i><span>Export Excel</span>
          </button>
        </div>
      </div>

      <div class="overflow-x-auto scrollbar">
        <table class="min-w-full text-sm">
          <thead class="bg-slate-950/80">
          <tr>
            <th class="px-4 py-3 text-left text-[11px] font-semibold text-slate-400 uppercase">#</th>
            <th class="px-4 py-3 text-left text-[11px] font-semibold text-slate-400 uppercase">GSTIN</th>
            <th class="px-4 py-3 text-left text-[11px] font-semibold text-slate-400 uppercase">Legal Name</th>
            <th class="px-4 py-3 text-left text-[11px] font-semibold text-slate-400 uppercase">Trade Name</th>
            <th class="px-4 py-3 text-left text-[11px] font-semibold text-slate-400 uppercase">Status</th>
            <th class="px-4 py-3 text-left text-[11px] font-semibold text-slate-400 uppercase">Constitution</th>
            <th class="px-4 py-3 text-left text-[11px] font-semibold text-slate-400 uppercase">State</th>
            <th class="px-4 py-3 text-left text-[11px] font-semibold text-slate-400 uppercase">GST Type</th>
            <th class="px-4 py-3 text-center text-[11px] font-semibold text-slate-400 uppercase">Details</th>
          </tr>
          </thead>
          <tbody id="resultsTableBody" class="divide-y divide-slate-800/80"></tbody>
        </table>
      </div>
    </div>
  </section>
</main>

<!-- History -->
<div id="historyOverlay" class="fixed inset-0 bg-black/70 hidden z-40" onclick="closeHistory()"></div>
<div id="historyPanel" class="fixed inset-y-0 right-0 w-full sm:w-[420px] glass slide-over z-50 shadow-2xl">
  <div class="h-full flex flex-col">
    <div class="flex items-center justify-between px-6 py-4 border-b border-slate-700/70">
      <div class="flex items-center gap-2">
        <div class="bg-emerald-500/15 p-2 rounded-lg">
          <i data-lucide="clock" class="w-5 h-5 text-emerald-400"></i>
        </div>
        <h3 class="text-base font-semibold">Session History</h3>
      </div>
      <button onclick="closeHistory()" class="text-slate-400 hover:text-white">
        <i data-lucide="x" class="w-5 h-5"></i>
      </button>
    </div>
    <div id="historyContent" class="flex-1 overflow-y-auto px-6 py-4 space-y-3 scrollbar"></div>
    <div class="px-6 pb-4 pt-2 border-t border-slate-700/70">
      <button
        onclick="clearHistory()"
        class="w-full px-4 py-2 rounded-xl bg-red-500/90 hover:bg-red-600 text-sm font-semibold flex items-center justify-center gap-2"
      >
        <i data-lucide="trash-2" class="w-4 h-4"></i><span>Clear History</span>
      </button>
    </div>
  </div>
</div>

<!-- Full Details Modal -->
<div id="detailsModal" class="fixed inset-0 z-50 hidden">
  <div class="absolute inset-0 bg-black/80" onclick="closeDetailsModal()"></div>
  <div class="relative h-full flex items-center justify-center p-4">
    <div class="glass rounded-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto scrollbar">
      <div class="flex items-center justify-between px-6 py-4 border-b border-slate-700/70">
        <div class="flex items-center gap-2">
          <div class="gradient-main p-2 rounded-lg">
            <i data-lucide="file-text" class="w-5 h-5 text-white"></i>
          </div>
          <h3 class="text-lg font-semibold">Complete GST Profile</h3>
        </div>
        <button onclick="closeDetailsModal()" class="text-slate-400 hover:text-white">
          <i data-lucide="x" class="w-5 h-5"></i>
        </button>
      </div>
      <div id="modalContent" class="p-6"></div>
    </div>
  </div>
</div>

<script>
  // ========= CLIENT CONFIG =========
  const ACCESS_PASSWORD = 'chirag930'; // not shown anywhere in UI

  let verificationResults = [];
  let isProcessing = false;
  let currentGSTDetails = null;

  // Initial icons
  document.addEventListener('DOMContentLoaded', () => {
    lucide.createIcons();
    // auto-unlock if already authenticated in this browser session
    if (sessionStorage.getItem('gst-sentinel-auth') === '1') {
      document.getElementById('loginOverlay').style.display = 'none';
    }
  });

  // Login logic (frontend gate)
  document.getElementById('loginForm').addEventListener('submit', (e) => {
    e.preventDefault();
    const pwd = document.getElementById('loginPassword').value;
    const errorDiv = document.getElementById('loginError');
    if (pwd === ACCESS_PASSWORD) {
      sessionStorage.setItem('gst-sentinel-auth', '1');
      document.getElementById('loginOverlay').style.display = 'none';
    } else {
      errorDiv.textContent = 'Invalid password.';
      errorDiv.classList.remove('hidden');
    }
  });

  // Utility: call backend API
  async function callVerifyApi(gstNumber) {
    const res = await fetch('/api/verify-gst.php', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ gst_number: gstNumber })
    });
    if (!res.ok) throw new Error('Network error');
    return await res.json();
  }

  // Single GST
  async function verifySingleGST() {
    const input = document.getElementById('singleGST');
    const gstNumber = input.value.trim().toUpperCase();
    const resultDiv = document.getElementById('singleResult');

    if (!gstNumber) {
      showNotification('Please enter GSTIN.', 'error');
      return;
    }
    if (gstNumber.length !== 15) {
      showNotification('GSTIN must be exactly 15 characters.', 'error');
      return;
    }

    resultDiv.classList.remove('hidden');
    resultDiv.innerHTML =
      '<div class="flex flex-col items-center justify-center py-6 text-slate-400">' +
      '<i data-lucide="loader" class="w-6 h-6 mb-2 animate-spin"></i>' +
      '<p>Verifying GST profile...</p></div>';
    lucide.createIcons();

    try {
      const data = await callVerifyApi(gstNumber);
      if (data.success && data.data) {
        const gst = data.data;
        currentGSTDetails = { ...gst, gst_number: gstNumber };
        addToHistory(currentGSTDetails);

        resultDiv.innerHTML = renderSingleCard(currentGSTDetails);
        lucide.createIcons();
        showNotification('GST verified successfully.', 'success');
      } else {
        resultDiv.innerHTML =
          `<div class="bg-red-500/10 border border-red-500/50 rounded-xl p-4 text-sm text-red-400">
            <div class="flex items-center gap-2">
              <i data-lucide="alert-circle" class="w-5 h-5"></i>
              <span>${data.message || 'Verification failed.'}</span>
            </div>
          </div>`;
        lucide.createIcons();
      }
    } catch (err) {
      resultDiv.innerHTML =
        `<div class="bg-red-500/10 border border-red-500/50 rounded-xl p-4 text-sm text-red-400">
          <strong>Error:</strong> ${err.message}
        </div>`;
    }
  }

  function renderSingleCard(gst) {
    const addr = gst.address || {};
    const juris = gst.jurisdiction || {};
    const nature = Array.isArray(gst.business_nature) ? gst.business_nature : [];

    return `
      <div class="glass rounded-xl p-5 border border-emerald-500/40 fade-in">
        <div class="flex flex-col md:flex-row md:items-start md:justify-between gap-4 mb-4 border-b border-slate-700/60 pb-4">
          <div>
            <div class="flex items-center gap-2 mb-1">
              <h3 class="text-xl font-bold text-emerald-400">${gst.legal_name}</h3>
              <span class="px-3 py-1 rounded-full text-xs font-semibold ${statusClass(gst.status)}">
                ${gst.status}
              </span>
            </div>
            <p class="text-xs text-slate-400 font-mono">${gst.gst_type || 'N/A'} • ${gst.gst_number}</p>
          </div>
          <button
            onclick='openDetailsModal(${JSON.stringify(gstWithNumber(gst))})'
            class="px-3 py-1.5 rounded-lg bg-emerald-500/15 text-xs text-emerald-400 hover:bg-emerald-500/30 flex items-center gap-1"
          >
            <i data-lucide="maximize-2" class="w-3 h-3"></i><span>Full Details</span>
          </button>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
          <div>
            <p class="text-[11px] text-slate-400 uppercase mb-1">Trade Name</p>
            <p class="text-sm font-semibold">${gst.trade_name || 'N/A'}</p>
          </div>
          <div>
            <p class="text-[11px] text-slate-400 uppercase mb-1">Constitution</p>
            <p class="text-sm font-semibold">${gst.constitution || 'N/A'}</p>
          </div>
          <div>
            <p class="text-[11px] text-slate-400 uppercase mb-1">Registration Date</p>
            <p class="text-sm font-semibold">${gst.registration_date || 'N/A'}</p>
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
          <div class="bg-slate-950/70 rounded-lg p-3">
            <p class="text-[11px] text-slate-400 uppercase mb-1 flex items-center gap-1">
              <i data-lucide="map-pin" class="w-3 h-3"></i> Address
            </p>
            <p class="text-xs text-slate-200">
              ${(addr.building || '') ? addr.building + ', ' : ''}
              ${(addr.location || '') ? addr.location + ', ' : ''}
              ${addr.city || ''}, ${addr.state || ''} - ${addr.pincode || ''}
            </p>
          </div>
          <div class="bg-slate-950/70 rounded-lg p-3">
            <p class="text-[11px] text-slate-400 uppercase mb-1 flex items-center gap-1">
              <i data-lucide="landmark" class="w-3 h-3"></i> Jurisdiction
            </p>
            <p class="text-[11px] text-slate-300">State: <span class="font-semibold">${juris.state || 'N/A'}</span></p>
            <p class="text-[11px] text-slate-300">Center: <span class="font-semibold">${juris.center || 'N/A'}</span></p>
          </div>
        </div>

        <div class="flex flex-wrap gap-2 mb-3">
          ${nature.map(n => `
            <span class="px-2.5 py-1 rounded-lg bg-emerald-500/15 text-[11px] text-emerald-300">
              ${n}
            </span>`).join('')}
        </div>

        <p class="text-[11px] text-slate-500">Last updated: ${gst.last_updated || 'N/A'}</p>
      </div>
    `;
  }

  function gstWithNumber(gst) {
    return { ...gst, gst_number: gst.gst_number || '' };
  }

  // Bulk file handling
  const dropZone = document.getElementById('dropZone');
  const fileInput = document.getElementById('fileInput');

  dropZone.addEventListener('click', () => fileInput.click());
  dropZone.addEventListener('dragover', e => {
    e.preventDefault();
    dropZone.classList.add('drag-over');
  });
  dropZone.addEventListener('dragleave', () => dropZone.classList.remove('drag-over'));
  dropZone.addEventListener('drop', e => {
    e.preventDefault();
    dropZone.classList.remove('drag-over');
    const file = e.dataTransfer.files[0];
    if (file) handleFile(file);
  });
  fileInput.addEventListener('change', e => {
    const file = e.target.files[0];
    if (file) handleFile(file);
  });

  async function handleFile(file) {
    if (isProcessing) {
      showNotification('Already processing a file.', 'error');
      return;
    }
    const reader = new FileReader();
    reader.onload = async e => {
      try {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        const rows = XLSX.utils.sheet_to_json(sheet, { header: 1 });
        const gstNumbers = rows.slice(1).map(r => String(r[0] || '').trim().toUpperCase()).filter(g => g.length === 15);
        if (!gstNumbers.length) {
          showNotification('No valid GSTIN found in first column.', 'error');
          return;
        }
        await processBulk(gstNumbers);
      } catch (err) {
        showNotification('File read error: ' + err.message, 'error');
      }
    };
    reader.readAsArrayBuffer(file);
  }

  async function processBulk(gstNumbers) {
    isProcessing = true;
    verificationResults = [];
    const progressContainer = document.getElementById('progressContainer');
    const bar = document.getElementById('progressBar');
    const text = document.getElementById('progressText');
    const count = document.getElementById('progressCount');
    progressContainer.classList.remove('hidden');
    document.getElementById('resultsSection').classList.add('hidden');

    let completed = 0;
    const total = gstNumbers.length;

    for (const gst of gstNumbers) {
      try {
        const res = await callVerifyApi(gst);
        if (res.success && res.data) {
          const full = { ...res.data, gst_number: gst };
          verificationResults.push(full);
          addToHistory(full);
        } else {
          verificationResults.push({
            gst_number: gst,
            legal_name: 'N/A',
            trade_name: 'N/A',
            status: 'Error',
            constitution: 'N/A',
            gst_type: 'N/A',
            address: { state: 'N/A' },
            business_nature: [],
            last_updated: '',
            jurisdiction: {},
            error_message: res.message || 'Failed'
          });
        }
      } catch (err) {
        verificationResults.push({
          gst_number: gst,
          legal_name: 'N/A',
          trade_name: 'N/A',
          status: 'Error',
          constitution: 'N/A',
          gst_type: 'N/A',
          address: { state: 'N/A' },
          business_nature: [],
          last_updated: '',
          jurisdiction: {},
          error_message: err.message
        });
      }
      completed++;
      const pct = (completed / total) * 100;
      bar.style.width = pct + '%';
      text.textContent = `Verifying ${completed}/${total} records...`;
      count.textContent = `${completed}/${total}`;
      await new Promise(r => setTimeout(r, 500));
    }

    text.textContent = 'Completed.';
    displayResults();
    isProcessing = false;
    setTimeout(() => progressContainer.classList.add('hidden'), 2000);
    showNotification(`Verified ${total} GSTINs.`, 'success');
  }

  function displayResults() {
    const tbody = document.getElementById('resultsTableBody');
    const section = document.getElementById('resultsSection');
    const count = document.getElementById('resultCount');
    tbody.innerHTML = '';
    verificationResults.forEach((r, i) => {
      const addr = r.address || {};
      const row = document.createElement('tr');
      row.className = 'hover:bg-slate-900/70 transition';
      row.innerHTML = `
        <td class="px-4 py-3 text-[11px] text-slate-400">${i + 1}</td>
        <td class="px-4 py-3 text-[12px] font-mono text-emerald-400">${r.gst_number}</td>
        <td class="px-4 py-3 text-[12px] font-semibold">${r.legal_name}</td>
        <td class="px-4 py-3 text-[12px] text-slate-200">${r.trade_name || 'N/A'}</td>
        <td class="px-4 py-3">
          <span class="px-2.5 py-1 rounded-full text-[10px] font-semibold ${statusClass(r.status)}">
            ${r.status}
          </span>
        </td>
        <td class="px-4 py-3 text-[12px]">${r.constitution || 'N/A'}</td>
        <td class="px-4 py-3 text-[12px]">${addr.state || 'N/A'}</td>
        <td class="px-4 py-3 text-[12px] text-slate-200">${r.gst_type || 'N/A'}</td>
        <td class="px-4 py-3 text-center">
          <button
            onclick='openDetailsModal(${JSON.stringify(r)})'
            class="px-2 py-1 rounded-lg bg-emerald-500/15 text-[11px] text-emerald-300 hover:bg-emerald-500/30"
          >
            <i data-lucide="eye" class="w-3 h-3"></i>
          </button>
        </td>
      `;
      tbody.appendChild(row);
    });
    count.textContent = verificationResults.length;
    section.classList.remove('hidden');
    lucide.createIcons();
  }

  function exportToExcel() {
    if (!verificationResults.length) {
      showNotification('No data to export.', 'error');
      return;
    }
    const rows = verificationResults.map((r, idx) => {
      const addr = r.address || {};
      const j = r.jurisdiction || {};
      return {
        'Sr No': idx + 1,
        'GSTIN': r.gst_number,
        'Legal Name': r.legal_name,
        'Trade Name': r.trade_name || '',
        'Status': r.status,
        'Constitution': r.constitution || '',
        'Registration Date': r.registration_date || '',
        'GST Type': r.gst_type || '',
        'State': addr.state || '',
        'City': addr.city || '',
        'Pincode': addr.pincode || '',
        'Address': [addr.building, addr.location, addr.city, addr.state, addr.pincode].filter(Boolean).join(', '),
        'Business Nature': (r.business_nature || []).join(', '),
        'Last Updated': r.last_updated || '',
        'Jurisdiction State': j.state || '',
        'Jurisdiction Center': j.center || ''
      };
    });
    const ws = XLSX.utils.json_to_sheet(rows);
    ws['!cols'] = [
      { wch: 6 }, { wch: 18 }, { wch: 30 }, { wch: 25 }, { wch: 10 },
      { wch: 18 }, { wch: 14 }, { wch: 10 }, { wch: 20 }, { wch: 18 },
      { wch: 10 }, { wch: 45 }, { wch: 25 }, { wch: 15 }, { wch: 25 }, { wch: 25 }
    ];
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'GST Verification');
    const ts = new Date().toISOString().slice(0, 10);
    XLSX.writeFile(wb, `GST_Sentinel_Report_${ts}.xlsx`);
    showNotification('Excel report generated.', 'success');
  }

  function clearResults() {
    verificationResults = [];
    document.getElementById('resultsTableBody').innerHTML = '';
    document.getElementById('resultsSection').classList.add('hidden');
    showNotification('Results cleared.', 'success');
  }

  // History
  function addToHistory(gst) {
    let hist = JSON.parse(localStorage.getItem('gstHistory') || '[]');
    hist.unshift({
      ...gst,
      timestamp: new Date().toISOString()
    });
    hist = hist.slice(0, 100);
    localStorage.setItem('gstHistory', JSON.stringify(hist));
  }

  function loadHistory() {
    const container = document.getElementById('historyContent');
    const hist = JSON.parse(localStorage.getItem('gstHistory') || '[]');
    if (!hist.length) {
      container.innerHTML = '<p class="text-xs text-slate-500 text-center mt-6">No history yet.</p>';
      return;
    }
    container.innerHTML = hist.map(item => {
      const addr = item.address || {};
      return `
        <div
          class="glass rounded-xl p-3 border border-slate-700 hover:border-emerald-500/60 cursor-pointer transition"
          onclick="fillGSTFromHistory('${item.gst_number}')"
        >
          <div class="flex items-center justify-between mb-1">
            <p class="font-mono text-[11px] text-emerald-400">${item.gst_number}</p>
            <span class="px-2 py-0.5 rounded-full text-[10px] font-semibold ${statusClass(item.status)}">
              ${item.status}
            </span>
          </div>
          <p class="text-xs font-semibold">${item.legal_name}</p>
          <p class="text-[10px] text-slate-500">${addr.state || 'N/A'} • ${item.constitution || 'N/A'}</p>
          <p class="text-[10px] text-slate-600 mt-1">
            ${new Date(item.timestamp).toLocaleString('en-IN')}
          </p>
        </div>
      `;
    }).join('');
  }

  function openHistory() {
    loadHistory();
    document.getElementById('historyPanel').classList.add('open');
    document.getElementById('historyOverlay').classList.remove('hidden');
  }

  function closeHistory() {
    document.getElementById('historyPanel').classList.remove('open');
    document.getElementById('historyOverlay').classList.add('hidden');
  }

  function clearHistory() {
    localStorage.removeItem('gstHistory');
    loadHistory();
    showNotification('History cleared.', 'success');
  }

  function fillGSTFromHistory(gst) {
    document.getElementById('singleGST').value = gst;
    closeHistory();
    verifySingleGST();
  }

  // Modal
  function openDetailsModal(gstData) {
    const modal = document.getElementById('detailsModal');
    const content = document.getElementById('modalContent');
    if (typeof gstData === 'string') gstData = JSON.parse(gstData);
    const addr = gstData.address || {};
    const j = gstData.jurisdiction || {};
    const nature = Array.isArray(gstData.business_nature) ? gstData.business_nature : [];

    content.innerHTML = `
      <div class="space-y-5">
        <div class="gradient-main rounded-xl p-5 text-white">
          <div class="flex items-start justify-between">
            <div>
              <p class="text-xs opacity-80">GSTIN</p>
              <p class="font-mono text-sm mb-1">${gstData.gst_number || ''}</p>
              <h2 class="text-xl font-bold mb-1">${gstData.legal_name}</h2>
              <p class="text-xs opacity-80">${gstData.trade_name || ''}</p>
            </div>
            <span class="px-3 py-1 rounded-full text-[11px] font-semibold bg-black/25">
              ${gstData.status}
            </span>
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div class="glass rounded-xl p-4 border border-slate-700">
            <p class="text-[11px] text-slate-400 uppercase mb-2">Business Info</p>
            <p class="text-xs text-slate-300">Constitution: <span class="font-semibold">${gstData.constitution || 'N/A'}</span></p>
            <p class="text-xs text-slate-300">GST Type: <span class="font-semibold">${gstData.gst_type || 'N/A'}</span></p>
            <p class="text-xs text-slate-300">Registration Date: <span class="font-semibold">${gstData.registration_date || 'N/A'}</span></p>
            <p class="text-xs text-slate-300">Last Updated: <span class="font-semibold">${gstData.last_updated || 'N/A'}</span></p>
          </div>
          <div class="glass rounded-xl p-4 border border-slate-700">
            <p class="text-[11px] text-slate-400 uppercase mb-2">Business Nature</p>
            <div class="flex flex-wrap gap-1.5">
              ${nature.map(n => `<span class="px-2 py-1 rounded-lg bg-emerald-500/10 text-[11px] text-emerald-300">${n}</span>`).join('')}
            </div>
          </div>
        </div>

        <div class="glass rounded-xl p-4 border border-slate-700">
          <p class="text-[11px] text-slate-400 uppercase mb-2">Address</p>
          <p class="text-xs text-slate-200">
            ${(addr.building || '') ? addr.building + ',<br>' : ''}
            ${(addr.location || '') ? addr.location + ',<br>' : ''}
            ${addr.city || ''}, ${addr.state || ''} - ${addr.pincode || ''}
          </p>
        </div>

        <div class="glass rounded-xl p-4 border border-slate-700">
          <p class="text-[11px] text-slate-400 uppercase mb-2">Jurisdiction</p>
          <p class="text-xs text-slate-300">State: <span class="font-semibold">${j.state || 'N/A'}</span></p>
          <p class="text-xs text-slate-300">Center: <span class="font-semibold">${j.center || 'N/A'}</span></p>
        </div>
      </div>
    `;
    modal.classList.remove('hidden');
    lucide.createIcons();
  }

  function closeDetailsModal() {
    document.getElementById('detailsModal').classList.add('hidden');
  }

  // Helpers
  function statusClass(s) {
    s = (s || '').toLowerCase();
    if (s === 'active') return 'status-active';
    if (s === 'cancelled') return 'status-cancelled';
    if (s === 'suspended') return 'status-suspended';
    return 'status-unknown';
  }

  function showNotification(message, type = 'info') {
    const colors = {
      success: 'from-emerald-500 to-emerald-600',
      error: 'from-red-500 to-red-600',
      info: 'from-sky-500 to-sky-600'
    };
    const icons = {
      success: 'check-circle',
      error: 'alert-circle',
      info: 'info'
    };
    const toast = document.createElement('div');
    toast.className = `fixed top-5 right-5 z-50 bg-gradient-to-r ${colors[type]} text-white px-4 py-3 rounded-xl shadow-xl text-xs flex items-center gap-2 fade-in`;
    toast.innerHTML = `<i data-lucide="${icons[type]}" class="w-4 h-4"></i><span>${message}</span>`;
    document.body.appendChild(toast);
    lucide.createIcons();
    setTimeout(() => toast.remove(), 3500);
  }

  document.getElementById('singleGST').addEventListener('keypress', e => {
    if (e.key === 'Enter') {
      e.preventDefault();
      verifySingleGST();
    }
  });
</script>
</body>
</html>
